@page "/admin"
@layout MainLayout
@attribute [Authorize]
@inject DialogService DialogService
@inject ITeamService TeamService
@inject ITurnInfoService TurnInfoService

<title>Admin - CFBR Orders</title>

<h1>Order Allocations</h1>

<div style="margin-bottom: 20px; display:flex; gap:20px; align-items:center;">

    <div>
        <label><b>Season:</b></label>
        <RadzenDropDown @bind-Value="selectedSeason"
                        Data="@availableSeasons"
                        Change="OnSeasonChanged"
                        Style="width: 150px;" />

    </div>

    <div>
        <label><b>Turn:</b></label>
        <RadzenDropDown @bind-Value="selectedTurn"
                        Data="@availableTurns"
                        Change="OnTurnChanged"
                        Style="width: 150px;" />

    </div>

</div>

@if (!orderAllocations.Any())
{
    <div class="nothing-found">
        No order allocations found for Season @selectedSeason Turn @selectedTurn, please check back later.
    </div>
}
else
{
    <p>
        Showing allocations for <b>@CurrentUser.Team</b> for Season <b>@selectedSeason</b> Turn <b>@selectedTurn</b>.
    </p>

    <h3>Tier Summary</h3>

    <RadzenDataGrid Data="@tierSummaries"
                    TItem="TierSummary"
                    AllowFiltering="false"
                    AllowSorting="true"
                    AllowPaging="false">

        <Columns>
            <RadzenDataGridColumn TItem="TierSummary" Property="Tier" Title="Tier" />
            <RadzenDataGridColumn TItem="TierSummary" Property="Players" Title="Players" />
            <RadzenDataGridColumn TItem="TierSummary" Property="Quota" Title="Starpower Allocated" />
            <RadzenDataGridColumn TItem="TierSummary" Property="AssignedStars" Title="Starpower Selected" />

            <RadzenDataGridColumn TItem="TierSummary" Title="Starpower Completed %">
                <Template Context="t">
                    @($"{t.QuotaPercent:F1}%")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="TierSummary" Property="TotalTerritories" Title="Total Territories" />
            <RadzenDataGridColumn TItem="TierSummary" Property="CompletedTerritories" Title="Completed Territories" />

            <RadzenDataGridColumn TItem="TierSummary" Title="Territory Completed %">
                <Template Context="t">
                    @($"{t.CompletedPercent:F1}%")
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    @foreach (var tierGroup in orderAllocations.GroupBy(orderAllocation => orderAllocation.Tier).OrderBy(group => group.Key))
    {
        <h3>Tier @tierGroup.Key</h3>

        <RadzenDataGrid Data="@tierGroup"
                        TItem="OrderAllocation"
                        AllowFiltering="false"
                        AllowSorting="true"
                        AllowPaging="false">

            <Columns>
                <RadzenDataGridColumn TItem="OrderAllocation" Property="TerritoryName" Title="Territory">
                    <Template Context="allocation">
                        <RadzenButton Text="@allocation.TerritoryName"
                                      Click="@(args => ShowUsersAsync(allocation))" />

                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="OrderAllocation" Property="StarpowerAllocated" Title="Starpower Allocated" />
                <RadzenDataGridColumn TItem="OrderAllocation" Property="StarpowerUsed" Title="Starpower Selected" />

                <RadzenDataGridColumn TItem="OrderAllocation" Title="Completed %">
                    <Template Context="allocation">
                        @(allocation.StarpowerAllocated.HasValue && allocation.StarpowerAllocated > 0 
                            ? $"{((double)(allocation.StarpowerUsed ?? 0) / allocation.StarpowerAllocated.Value) * 100:F1}%" 
                            : "0%")
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
}

@code {
    [CascadingParameter]
    public CurrentUser CurrentUser { get; set; }

    private List<OrderAllocation> orderAllocations = new();
    private List<UserOrder> userOrders = new();
    private List<TierSummary> tierSummaries = new();

    private int teamId;
    private string ownerName;

    private List<int> availableSeasons = new();
    private List<int> availableTurns = new();

    private int selectedSeason;
    private int selectedTurn;

    private OrderAllocation? selectedTerritory;
    private List<UserOrder> selectedUserOrders = new();

    protected override void OnInitialized()
    {
        teamId = CurrentUser.TeamId;

        availableSeasons = TurnInfoService.GetAllSeasons();
        selectedSeason = availableSeasons.FirstOrDefault();

        availableTurns = TurnInfoService.GetAllTurnsBySeason(selectedSeason);
        selectedTurn = availableTurns.FirstOrDefault();

        LoadAllocations();
    }

    private void LoadAllocations()
    {
        orderAllocations = OrderAllocationService
            .GetAllOrderAllocations(teamId, selectedSeason, selectedTurn)
            ?.OrderBy(o => o.TerritoryName)
            .ToList() ?? new();

        userOrders = UserOrderService.GetAllUserOrdersByTurn(selectedSeason, selectedTurn);

        tierSummaries = OrderAllocationService.GetTierSummaries(orderAllocations, userOrders);

        StateHasChanged();
    }


    private void OnSeasonChanged(object value)
    {
        selectedSeason = (int)value;

        availableTurns = TurnInfoService.GetAllTurnsBySeason(selectedSeason);
        selectedTurn = availableTurns.FirstOrDefault();

        LoadAllocations();
    }

    private void OnTurnChanged(object value)
    {
        selectedTurn = (int)value;
        LoadAllocations();
    }

    private async Task ShowUsersAsync(OrderAllocation allocation)
    {
        selectedTerritory = allocation;

        if (allocation.TeamId != allocation.OwnerId && allocation.OwnerId.HasValue)
        {
            ownerName = TeamService.GetTeamNameByTeamId(allocation.OwnerId.Value);
        }

        selectedUserOrders = userOrders
            .Where(o => o.TerritoryId == allocation.TerritoryId)
            .OrderByDescending(o => o.Starpower)
            .ToList();

        await DialogService.OpenAsync(
            $"{selectedTerritory.TerritoryName}",
            ds => @<div>

            @if (!string.IsNullOrEmpty(ownerName))
            {
                <p><b>Previous Owner:</b> @ownerName</p>
            }
                
                <p><b>Tier:</b> @selectedTerritory.Tier</p>

                <h4>Users Who Selected This Territory</h4>

                @if (selectedUserOrders.Any())
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Starpower</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var userOrder in selectedUserOrders)
                        {
                            <tr>
                                <td>@userOrder.Username</td>
                                <td>@userOrder.Starpower</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="nothing-found">No users moved here.</p>
                }

                <RadzenButton Text="Close" Click="() => ds.Close()" class="margin-top-20" />

            </div>,
            new DialogOptions()
            {
                Width = "650px",
                Height = "auto",
                CloseDialogOnOverlayClick = true
            }
        );
    }
}
