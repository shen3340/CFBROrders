@page "/admin"
@layout MainLayout
@attribute [Authorize]
@inject DialogService DialogService

<h1>Order Allocations</h1>

@if (!orderAllocations.Any())
{
    <div style="margin-top:20px; padding:10px; color:red; font-weight:bold;">
        No order allocations found for Season @season Turn @upcomingRoll, please check back later.
    </div>
}
else
{
    <p>
        Showing allocations for <b>@CurrentUser.Team</b> for Season <b>@season</b> Turn <b>@upcomingRoll</b>.
    </p>

    <h3>Tier Summary</h3>

    <RadzenDataGrid Data="@GetTierSummaries()"
                    TItem="dynamic"
                    AllowFiltering="false"
                    AllowSorting="true"
                    AllowPaging="false">

        <Columns>
            <RadzenDataGridColumn TItem="dynamic" Property="Tier" Title="Tier" />
            <RadzenDataGridColumn TItem="dynamic" Property="Players" Title="Players" />
            <RadzenDataGridColumn TItem="dynamic" Property="Quota" Title="Starpower Allocated" />
            <RadzenDataGridColumn TItem="dynamic" Property="AssignedStars" Title="Starpower Selected" />

            <RadzenDataGridColumn TItem="dynamic" Title="Starpower Completed %">
                <Template Context="t">
                    @($"{t.QuotaPercent:F1}%")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="dynamic" Property="TotalTerritories" Title="Total Territories" />
            <RadzenDataGridColumn TItem="dynamic" Property="CompletedTerritories" Title="Completed Territories" />

            <RadzenDataGridColumn TItem="dynamic" Title="Territory Completed %">
                <Template Context="t">
                    @($"{t.CompletedPercent:F1}%")
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    @foreach (var tierGroup in orderAllocations.GroupBy(orderAllocation => orderAllocation.Tier).OrderBy(group => group.Key))
    {
        <h3>Tier @tierGroup.Key</h3>

        <RadzenDataGrid Data="@tierGroup"
                        TItem="OrderAllocation"
                        AllowFiltering="false"
                        AllowSorting="true"
                        AllowPaging="false">

            <Columns>
                <RadzenDataGridColumn TItem="OrderAllocation" Property="TerritoryName" Title="Territory">
                    <Template Context="allocation">
                        <RadzenButton Text="@allocation.TerritoryName"
                                      Style="padding:4px;"
                                      Click="@(args => ShowUsersAsync(allocation))" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="OrderAllocation" Property="StarpowerAllocated" Title="Starpower Allocated" />
                <RadzenDataGridColumn TItem="OrderAllocation" Property="StarpowerUsed" Title="Starpower Selected" />

                <RadzenDataGridColumn TItem="OrderAllocation" Title="Completed %">
                    <Template Context="allocation">
                        @(allocation.StarpowerAllocated.HasValue && allocation.StarpowerAllocated > 0 
                            ? $"{((double)(allocation.StarpowerUsed ?? 0) / allocation.StarpowerAllocated.Value) * 100:F1}%" 
                            : "0%")
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
}

@code {
    [CascadingParameter]
    public CurrentUser CurrentUser { get; set; }

    private List<OrderAllocation> orderAllocations = new();
    private List<UserOrder> userOrders = new();

    private int season;
    private int lastRoll;
    private int upcomingRoll;
    private int teamId;

    private OrderAllocation? selectedTerritory;
    private List<UserOrder> selectedUserOrders = new();


    protected override void OnInitialized()
    {
        teamId = CurrentUser.TeamId;
        season = CurrentUser.Season;
        lastRoll = CurrentUser.Turn;
        upcomingRoll = lastRoll + 1;

        orderAllocations = OrderAllocationService
            .GetAllOrderAllocations(teamId, season, upcomingRoll)
            ?.OrderBy(orderAllocation => orderAllocation.TerritoryName)
            .ToList() ?? new();

        userOrders = UserOrderService.GetAllUserOrdersByTurn(season, upcomingRoll);
    }

    private IEnumerable<object> GetTierSummaries()
    {
        return orderAllocations
            .GroupBy(orderAllocation => orderAllocation.Tier)
            .Select(group => new
            {
                Tier = group.Key ?? 0,

                Players = userOrders
                    .Where(uo => group.Any(oa => oa.TerritoryId == uo.TerritoryId))
                    .Select(uo => uo.Username)
                    .Distinct()
                    .Count(),

                Quota = group.Sum(orderAllocation => orderAllocation.StarpowerAllocated ?? 0),
                AssignedStars = group.Sum(orderAllocation => orderAllocation.StarpowerUsed ?? 0),
                QuotaPercent = group.Sum(orderAllocation => orderAllocation.StarpowerAllocated ?? 0) > 0
                    ? (double)group.Sum(orderAllocation => orderAllocation.StarpowerUsed ?? 0) / group.Sum(orderAllocation => orderAllocation.StarpowerAllocated ?? 0) * 100
                    : 0,

                TotalTerritories = group.Count(),
                CompletedTerritories = group.Count(orderAllocation => orderAllocation.IsTerritoryFull),
                CompletedPercent = group.Count() > 0
                    ? (double)group.Count(orderAllocation => orderAllocation.IsTerritoryFull) / group.Count() * 100
                    : 0
            })
            .OrderBy(item => item.Tier)
            .ToList();
    }

    private async Task ShowUsersAsync(OrderAllocation allocation)
    {
        selectedTerritory = allocation;

        selectedUserOrders = userOrders
            .Where(o => o.TerritoryId == allocation.TerritoryId)
            .OrderByDescending(o => o.Starpower)
            .ToList();

        await DialogService.OpenAsync(
            $"{selectedTerritory.TerritoryName}",
            ds => @<div>

                <p><b>Tier:</b> @selectedTerritory.Tier</p>

                <h4>Users Who Selected This Territory</h4>

                @if (selectedUserOrders.Any())
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Starpower</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var u in selectedUserOrders)
                        {
                            <tr>
                                <td>@u.Username</td>
                                <td>@u.Starpower</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p style="color:red;font-weight:bold;">No users moved here.</p>
                }

                <RadzenButton Text="Close" Click="() => ds.Close()" Style="margin-top:20px;" />

            </div>,
            new DialogOptions()
            {
                Width = "650px",
                Height = "auto",
                CloseDialogOnOverlayClick = true
            }
        );
    }
}
