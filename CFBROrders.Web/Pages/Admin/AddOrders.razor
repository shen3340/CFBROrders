@page "/admin/AddOrders"
@layout MainLayout
@inject ILogger<AddOrders> _logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<h1>Add Orders</h1>
<hr />

<p>
    @username playing for @team has 
<span class="star"
    style="color:@color; text-shadow:0 0 5px @shadowColor;">
@(new string('✯', overall))
</span>
</p>

<p>
    Please add your orders. This amount should at most add up to your team star power, which is <strong>@starPower</strong>.
</p>

<h3>Defendable Territories</h3>
<RadzenDataGrid Data="@defendableTerritories"
                TItem="TerritoryOwnershipWithNeighbor"
                ShowPagingSummary="true"
                AllowFiltering="true"
                AllowSorting="true"
                AllowPaging="true"
                PageSize="@pageSize"
                PageSizeOptions="@pagingOptions">
    <Columns>
        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Property="Name" Title="Territory" />

        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Title="Neighbors and Owners">
            <Template Context="territory">
                @{
                    var opposingNeighbors = territory.NeighborList
                    .Where(n => n.Owner != team)
                    .ToList();
                }

                @if (opposingNeighbors.Any())
                {
                    <ul>
                        @foreach (var neighbor in opposingNeighbors)
                        {
                            <li>@neighbor.Name (@neighbor.Owner)</li>
                        }
                    </ul>
                }
                else
                {
                    <em>No opposing neighbors</em>
                }
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="StarPowerAllocation" Title="Star Power">
            <Template Context="territory">
                <RadzenNumeric @bind-Value="territory.StarPowerAllocation"
                               TValue="int"
                               Style="width:100%;"
                               Min="0"
                               Max="@starPower"/>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Property="Tier" Title="Tier">
            <Template Context="territory">
                <RadzenDropDown @bind-Value="territory.Tier"
                                Data="@tierOptions"
                                Style="width:100%"
                                AllowClear="false" />
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

<p>
    Defending Allocation Total: <strong>@TotalDefendable</strong>
</p>


<br />

<h3>Attackable Territories</h3>
<RadzenDataGrid Data="@attackableTerritories" 
                TItem="TerritoryOwnershipWithNeighbor"
                ShowPagingSummary="true" 
                AllowFiltering="true"
                AllowSorting="true" 
                AllowPaging="true" 
                PageSize="@pageSize" 
                PageSizeOptions="@pagingOptions">
    <Columns>
        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Property="Name" Title="Territory">
            <Template Context="n">@n.Name</Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Property="Tname" Title="Owner">
            <Template Context="n">@n.Tname</Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="StarPowerAllocation" Title="Star Power">
            <Template Context="territory">
                <RadzenNumeric @bind-Value="territory.StarPowerAllocation"
                               TValue="int"
                               Style="width:100%;"
                               Min="0"
                               Max="@starPower"/>
            </Template>
        </RadzenDataGridColumn>


        <RadzenDataGridColumn TItem="TerritoryOwnershipWithNeighbor" Property="Tier" Title="Tier">
            <Template Context="territory">
                <RadzenDropDown @bind-Value="territory.Tier"
                                Data="@tierOptions"
                                Style="width:100%"
                                AllowClear="false" />
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

<p>
    Attacking Allocation Total: <strong>@TotalAttackable</strong>
</p>

<p style="font-size:1.2em;">
    Total Star Power Used: <strong>@TotalStarPowerUsed</strong> / @starPower
</p>


<br />
<RadzenButton Text="Submit Orders"
              Icon="save"
              Style="margin-top:20px"
              Click="@SubmitOrders"/>

@code {
    [CascadingParameter] 
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private List<TerritoryOwnershipWithNeighbor> defendableTerritories = new();
    private List<TerritoryOwnershipWithNeighbor> attackableTerritories = new();

    int pageSize = 10;
    int[] pagingOptions = { 5, 10, 20, 50 };
    private List<int> tierOptions = Enumerable.Range(1, 10).ToList();

    private string username;
    private string team;
    private string color;
    private int overall;
    private int season = 5;
    private int lastRoll = 2;
    private int starPower;

    private string shadowColor;

    private int TotalDefendable => defendableTerritories.Sum(t => t.StarPowerAllocation);

    private int TotalAttackable => attackableTerritories.Sum(t => t.StarPowerAllocation);

    private int TotalStarPowerUsed => TotalDefendable + TotalAttackable;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        username = user.FindFirstValue("Username");
        team = user.FindFirstValue("CurrentTeam");
        overall = int.Parse(user.FindFirstValue("Overall"));
        color = user.FindFirstValue("Color");

        starPower = TeamService.GetTeamStarPowerForTurn(team, season, lastRoll - 1);

        defendableTerritories =
            TerritoryService.GetDefendableTerritories(season, lastRoll, team);

        attackableTerritories =
            TerritoryService.GetAttackableTerritories(season, lastRoll, team);

            shadowColor = GetContrastColor(color) == "white" ? "white" : "black";
    }

    private string GetContrastColor(string hexColor)
    {
        hexColor = hexColor.Replace("#", "");

        int r = Convert.ToInt32(hexColor.Substring(0, 2), 16);
        int g = Convert.ToInt32(hexColor.Substring(2, 2), 16);
        int b = Convert.ToInt32(hexColor.Substring(4, 2), 16);

        double luminance = (0.299 * r + 0.587 * g + 0.114 * b);

        return luminance > 150 ? "black" : "white";
    }

    private string GetNeighborDisplay(string neighborsJson)
    {
        if (string.IsNullOrWhiteSpace(neighborsJson)) return string.Empty;

        try
        {
            var neighbors = JsonSerializer.Deserialize<List<Neighbor>>(neighborsJson);

            if (neighbors == null || !neighbors.Any()) return string.Empty;

            return string.Join(", ", neighbors.Select(n => $"{n.Name} ({n.Owner})"));
        }
        catch
        {
            return "Invalid data";
        }
    }

    private async Task SubmitOrders()
    {
        var userTeamId = TeamService.GetTeamIdByTeamName(team);

        var allTerritories = defendableTerritories.Concat(attackableTerritories).ToList();

        var ownerTeamIds = allTerritories
            .Select(t => t.Tname)
            .Distinct()
            .ToDictionary(n => n, n => TeamService.GetTeamIdByTeamName(n));

        var allocations = allTerritories
            .Where(t => t.StarPowerAllocation > 0)
            .Select(t => new OrderAllocation
            {
                TurnId = lastRoll + 1,
                TeamId = userTeamId,
                TerritoryId = t.TerritoryId,
                OwnerId = ownerTeamIds[t.Tname!],
                StarpowerAllocation = t.StarPowerAllocation,
                Tier = t.Tier
            })
            .ToList();

        var total = allocations.Sum(x => x.StarpowerAllocation ?? 0);


        var result = OrderAllocationService.InsertOrderAllocations(allocations);

        if (result.IsError)
        {
            Navigation.NavigateTo("/error");
        }
    }
}
