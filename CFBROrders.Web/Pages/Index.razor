@page "/"
@layout MainLayout
@attribute [Authorize]

<h1>Welcome @CurrentUser.Username</h1>
<p>I'm trying to test something here'</p>

<span class="star"
        style="@($"color:{CurrentUser.Color}; text-shadow:0 0 5px {CurrentUser.ContrastColor};")">
        @(new string('✯', CurrentUser.Overall))
</span>

<p>Today is @DateTime.Today.ToLongDateString()</p>

<p>Click one of the buttons below to choose your deployment, solider!</p>

<RadzenButton Text="I want to Attack"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@ShowAttackChoices" />

<RadzenButton Text="I want to Defend"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@ShowDefendChoices" />

<RadzenButton Text="I want to manually pick my territory"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@ShowManualSelection" />

<RadzenButton Text="I don't care'"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@ShowIndifferentChoices" />

@if (showDefend)
{
    <ul>
        @foreach (var territory in randomDefend)
        {
            <br />
           <RadzenButton Text="@territory.Name"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@(args => SubmitOrUpdateUserOrder(territory))" />

        }
    </ul>
}

@if (showAttack)
{
    <ul>
        @foreach (var territory in randomAttack)
        {
            <br />
            <RadzenButton Text="@territory.Name"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@(args => SubmitOrUpdateUserOrder(territory))" />

        }
    </ul>
}

@if (showManual)
{
    <ul>
        @foreach (var territory in manual)
        {
            <br />
            <RadzenButton Text="@territory.Name"
                Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
                Click="@(args => SubmitOrUpdateUserOrder(territory))" />
        }
    </ul>
}


@if (showIndifferent)
{
    <ul>
        @foreach (var territory in randomIndifferent)
        {
            <br />
            <RadzenButton Text="@territory.Name"
              Style="@($"background-color:{CurrentUser.Color}; color:{CurrentUser.ContrastColor}; border-radius:0;")"
              Click="@(args => SubmitOrUpdateUserOrder(territory))" />

        }
    </ul>
}

@code {
    [CascadingParameter]
    public CurrentUser CurrentUser { get; set; }

    private List<TerritoryOwnershipWithNeighbor> randomDefend = new();
    private List<TerritoryOwnershipWithNeighbor> randomAttack = new();
    private List<TerritoryOwnershipWithNeighbor> randomIndifferent = new();
    private List<TerritoryOwnershipWithNeighbor> manual = new();

    private bool showManual = false;
    private bool showIndifferent = false;
    private bool showDefend = false;
    private bool showAttack = false;
    private int turn_id = 3;
    private int season = 5;

    private async Task ShowDefendChoices()
    {
        var defendable = TerritoryService.GetDefendableTerritories(season, turn_id, CurrentUser.Team);

        randomDefend = defendable
            .OrderBy(_ => Guid.NewGuid())
            .Take(3)
            .ToList();

        showDefend = true;
        showAttack = false;
    }

    private async Task ShowAttackChoices()
    {
        var attackable = TerritoryService.GetAttackableTerritories(season, turn_id, CurrentUser.Team);

        randomAttack = attackable
            .OrderBy(_ => Guid.NewGuid())
            .Take(3)
            .ToList();

        showAttack = true;
        showDefend = false;
    }

    private async Task ShowIndifferentChoices()
    {
        var defendable = TerritoryService.GetDefendableTerritories(season, turn_id, CurrentUser.Team);
        var attackable = TerritoryService.GetAttackableTerritories(season, turn_id, CurrentUser.Team);

        var allOptions = defendable.Concat(attackable).ToList();

        randomIndifferent = allOptions
            .OrderBy(_ => Guid.NewGuid())
            .Take(3)
            .ToList();

        showAttack = false;
        showDefend = false;
        showIndifferent = true;
    }

    private async Task ShowManualSelection()
    {
        var defendable = TerritoryService.GetDefendableTerritories(season, turn_id, CurrentUser.Team);
        var attackable = TerritoryService.GetAttackableTerritories(season, turn_id, CurrentUser.Team);

        manual = defendable.Concat(attackable)
            .OrderBy(t => t.Name) 
            .ToList();

        showAttack = false;
        showDefend = false;
        showIndifferent = false;
        showManual = true;
    }


    private async Task SubmitOrUpdateUserOrder(TerritoryOwnershipWithNeighbor territory)
    {
        var existingOrder = UserOrderService.GetUserOrder(CurrentUser.Username, season, turn_id);

        if (existingOrder == null)
        {
            var userOrder = new UserOrder
            {
                Username = CurrentUser.Username,
                SeasonId = season,
                TurnId = turn_id,
                Team = CurrentUser.Team,
                TerritoryId = territory.TerritoryId,
                Starpower = CurrentUser.Overall,   
            };

            var result = UserOrderService.InsertUserOrder(userOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }

        }
        else
        {
            existingOrder.TerritoryId = territory.TerritoryId;

            var result = UserOrderService.UpdateUserOrder(existingOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }
        }

        Navigation.NavigateTo($"/confirmation/{territory.Name}");
    }
}
