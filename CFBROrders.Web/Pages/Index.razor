@page "/"
@layout MainLayout
@inject ILogger<Index> _logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<h1>Welcome @username</h1>
<p> testing, pls work</p>

<span class="star"
    style="color:@color; text-shadow:0 0 5px @shadowColor;">
@(new string('✯', overall))
</span>

<p>Today is @DateTime.Today.ToLongDateString()</p>

<p>Click one of the buttons below to choose your deployment, solider!</p>

<RadzenButton Text="I want to Attack"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")"
              Click="@ShowAttackChoices" />

<RadzenButton Text="I want to Defend"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")"
              Click="@ShowDefendChoices" />

<RadzenButton Text="I want to manually pick my territory"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")" />

<RadzenButton Text="I don't care"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")" />

@if (showDefend)
{
    <ul>
        @foreach (var territory in randomDefend)
        {
            <br />
           <RadzenButton Text="@territory.Name"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")"
              Click="@(args => SubmitOrUpdateUserOrder(territory))" />

        }
    </ul>
}

@if (showAttack)
{
    <ul>
        @foreach (var territory in randomAttack)
        {
            <br />
            <RadzenButton Text="@territory.Name"
              Style="@($"background-color:{color}; color:{textColor}; border-radius:0;")"
              Click="@(args => SubmitOrUpdateUserOrder(territory))" />

        }
    </ul>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private List<TerritoryOwnershipWithNeighbor> randomDefend = new();
    private List<TerritoryOwnershipWithNeighbor> randomAttack = new();

    private bool showDefend = false;
    private bool showAttack = false;
    private string username;
    private string team;
    private string color;
    private string textColor;
    private string shadowColor;
    private int overall;
    private int turn_id = 3;
    private int season = 5;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        username = user.FindFirstValue("Username");
        team = user.FindFirstValue("CurrentTeam");
        overall = int.Parse(user.FindFirstValue("Overall"));
        color = user.FindFirstValue("Color");

        textColor = GetContrastColor(color);
        shadowColor = textColor == "white" ? "white" : "black";
    }

    private string GetContrastColor(string hexColor)
    {
        hexColor = hexColor.Replace("#", "");

        int r = Convert.ToInt32(hexColor.Substring(0, 2), 16);
        int g = Convert.ToInt32(hexColor.Substring(2, 2), 16);
        int b = Convert.ToInt32(hexColor.Substring(4, 2), 16);

        double luminance = (0.299 * r + 0.587 * g + 0.114 * b);

        return luminance > 150 ? "black" : "white";
    }

    private async Task ShowDefendChoices()
    {
        var defendable = TerritoryService.GetDefendableTerritories(season, turn_id, team);

        randomDefend = defendable
            .OrderBy(_ => Guid.NewGuid())
            .Take(3)
            .ToList();

        showDefend = true;
        showAttack = false;
    }

    private async Task ShowAttackChoices()
    {
        var attackable = TerritoryService.GetAttackableTerritories(season, turn_id, team);

        randomAttack = attackable
            .OrderBy(_ => Guid.NewGuid())
            .Take(3)
            .ToList();

        showAttack = true;
        showDefend = false;
    }

    private async Task SubmitOrUpdateUserOrder(TerritoryOwnershipWithNeighbor territory)
    {
        var existingOrder = UserOrderService.GetUserOrder(username, season, turn_id);

        if (existingOrder == null)
        {
            var userOrder = new UserOrder
            {
            Username = username,
            SeasonId = season,
            TurnId = turn_id,
            Team = team,
            TerritoryId = territory.TerritoryId,
            Starpower = overall,   
            };

            var result = UserOrderService.InsertUserOrder(userOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }

        }
        else
        {
            existingOrder.TerritoryId = territory.TerritoryId;

            var result = UserOrderService.UpdateUserOrder(existingOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }
        }

        Navigation.NavigateTo($"/confirmation/{territory.Name}");
    }
}
