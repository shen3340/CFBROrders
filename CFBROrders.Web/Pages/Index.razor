@page "/"
@layout MainLayout
@attribute [Authorize]

<title>Order Selection - CFBR Orders</title>

<h1>Welcome @CurrentUser.Username of Team @CurrentUser.Team</h1>

<span class="star">
    @(new string('✯', CurrentUser.Overall))
</span>

<p>Today is @EST.ToLongDateString()</p>

@if (ordersNotReady)
{
    <div class="nothing-found">
        Sorry, orders don’t seem to be loaded yet. Please check back later.
    </div>
}
else
{
    <p>Click one of the buttons below to choose your deployment, solider!</p>

    <RadzenButton Text="I want to Attack"
                  Click="@ShowAttackChoices"
                  class="choice-btn"/>

    <RadzenButton Text="I want to Defend"
                  Click="@ShowDefendChoices"
                  class="choice-btn"/>

    <RadzenButton Text="I want to manually pick my territory"
                  Click="@ShowManualSelection" 
                  class="choice-btn"/>

    <RadzenButton Text="Pick for me"
                  Click="@ShowIndifferentChoices"
                  class="choice-btn"/>
}

@if (manualOptions?.Any() == true)
{
    @RenderManualButtons(manualOptions)
}
@if (orderOptions?.Any() == true)
{
    @RenderTerritoryButtons(orderOptions)
}


@code {
    [CascadingParameter]
    public CurrentUser CurrentUser { get; set; }

    [CascadingParameter]
    public DateTime EST { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public string? edit { get; set; }

    private List<OrderAllocation> orderAllocations = new();
    private List<OrderAllocation> orderOptions = new();
    private List<TerritoryOwnershipWithNeighbor> manualOptions = new();
    private HashSet<int?> recommendedTerritoryIds = new();
    private int turn_id;
    private int season;

    private bool ordersNotReady = false;

    protected override async Task OnInitializedAsync()
    {
        season = CurrentUser.Season;
        turn_id = CurrentUser.Turn + 1;

        if (edit != "true")
        {
            var existingOrder = UserOrderService.GetSingleUserOrder(CurrentUser.Username, season, turn_id);

            if (existingOrder != null)
            {
                var territory = TerritoryService.GetTerritoryNameByTerritoryId(existingOrder.TerritoryId);

                Navigation.NavigateTo($"/confirmation/{territory}");

                return;
            }
        }

        orderAllocations = OrderAllocationService.GetAllOrderAllocations(CurrentUser.TeamId, season, turn_id);
        
        if (orderAllocations == null || !orderAllocations.Any())
        {
            ordersNotReady = true;
            return;
        }
    }

    private RenderFragment RenderTerritoryButtons(List<OrderAllocation> territoryList) => __builder =>
    {
        @foreach (var territory in territoryList)
        {
            <div class="margin-top-20">
                <RadzenButton Text="@territory.TerritoryName"
                                Click="@(args => SubmitOrUpdateUserOrder(territory))" />
            </div>
        }
    };

    private RenderFragment RenderManualButtons(List<TerritoryOwnershipWithNeighbor> territoryList) => __builder =>
    {
        foreach (var territory in territoryList)
        {
            bool isRecommended = recommendedTerritoryIds.Contains(territory.TerritoryId);

            <div class="margin-top-20">
                <RadzenButton Text="@($"{territory.Name}{(isRecommended ? " ⭐ Recommended" : "")}")"
                              Click="@(args => SubmitOrUpdateManualTerritory(territory))" />
            </div>
        }
    };

    private List<OrderAllocation> FilterUserOrders(List<OrderAllocation> allocations)
    {
        var notFull = allocations.Where(allocation => !allocation.IsTerritoryFull).ToList();

        var filtered = notFull.Any() ? notFull : allocations;

        filtered = filtered.OrderByDescending(allocation => allocation.Tier).ToList();

        return filtered.Take(3).ToList();
    }

    private void ShowDefendChoices()
    {
        orderOptions = FilterUserOrders(orderAllocations
            .Where(a => a.OwnerId == a.TeamId)
            .Where(a => a.StarpowerRemaining > 0)
            .ToList());

        manualOptions.Clear();
    }

    private void ShowAttackChoices()
    {
        orderOptions = FilterUserOrders(orderAllocations
            .Where(a => a.OwnerId != a.TeamId)
            .Where(a => a.StarpowerRemaining > 0)
            .ToList());

        manualOptions.Clear();
    }

    private void ShowIndifferentChoices()
    {
        orderOptions = FilterUserOrders(orderAllocations
            .Where(a => a.StarpowerRemaining > 0)
            .ToList());

        manualOptions.Clear();
    }

    private void ShowManualSelection()
    {
        var defendable = TerritoryService.GetDefendableTerritories(season, turn_id, CurrentUser.Team);
        var attackable = TerritoryService.GetAttackableTerritories(season, turn_id, CurrentUser.Team);

        manualOptions = defendable.Concat(attackable)
            .OrderBy(t => t.Name)
            .ToList();

        recommendedTerritoryIds = orderAllocations
            .Where(a => a.StarpowerRemaining > 0)
            .Select(a => a.TerritoryId)
            .ToHashSet();

        orderOptions.Clear();
    }

    private void SubmitOrUpdateUserOrder(OrderAllocation territory)
    {
        var existingOrder = UserOrderService.GetSingleUserOrder(CurrentUser.Username, season, turn_id);

        if (existingOrder == null)
        {
            var userOrder = new UserOrder
            {
                Username = CurrentUser.Username,
                SeasonId = season,
                TurnId = turn_id,
                Team = CurrentUser.Team,
                TerritoryId = territory.TerritoryId,
                Starpower = CurrentUser.Overall,   
            };

            var result = UserOrderService.InsertUserOrder(userOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }

        }
        else
        {
            existingOrder.TerritoryId = territory.TerritoryId;

            var result = UserOrderService.UpdateUserOrder(existingOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }
        }

        Navigation.NavigateTo($"/confirmation/{territory.TerritoryName}");
    }

    private void SubmitOrUpdateManualTerritory(TerritoryOwnershipWithNeighbor territory)
    {
        var existingOrder = UserOrderService.GetSingleUserOrder(CurrentUser.Username, season, turn_id);

        if (existingOrder == null)
        {
            var userOrder = new UserOrder
            {
                Username = CurrentUser.Username,
                SeasonId = season,
                TurnId = turn_id,
                Team = CurrentUser.Team,
                TerritoryId = territory.TerritoryId,
                Starpower = CurrentUser.Overall
            };

            var result = UserOrderService.InsertUserOrder(userOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }
        }
        else
        {
            existingOrder.TerritoryId = territory.TerritoryId;

            var result = UserOrderService.UpdateUserOrder(existingOrder);

            if (result.IsError)
            {
                Navigation.NavigateTo("/error");
                return;
            }
        }

        Navigation.NavigateTo($"/confirmation/{territory.Name}");
    }
}
