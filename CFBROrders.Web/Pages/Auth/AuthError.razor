@page "/autherror"
@inject NavigationManager NavigationManager

<h1>Authentication Error</h1>

@if (errorCode is "discord-auth-failed" or "invalid-discord-id")
{
    <p class="text-danger">
        Discord Authentication failed. Please try again to reauthenticate:
    </p>

    @ReLoginButtons()
    @ContactLinks()
}
else if (errorCode is "reddit-auth-failed" or "missingid")
{
    <p class="text-danger">
        Reddit Authentication failed. Please try again to reauthenticate:
    </p>

    @ReLoginButtons()
    @ContactLinks()
}
else if (errorCode == "not-registered")
{
    <p class="text-danger">
        You don't have an account with College Football Risk, please create an account here:
        <a href="https://collegefootballrisk.com" target="_blank">Create an account</a>
        <br /><br />
        After creating an account, click below to reauthenticate:
    </p>

    @ReLoginButtons()
    @ContactLinks()
}
else if (errorCode == "team-not-active")
{
    <p class="text-danger">
        Your account isn't associated with an active team in this season of College Football Risk.
        Please make sure your account is associated with an active team  
        <a href="https://collegefootballrisk.com" target="_blank">HERE</a> 
        <br /><br />
        After joining an active team, click below to reauthenticate:
    </p>

    @ReLoginButtons()
    @ContactLinks()
}
else
{
    <p class="text-danger">An unknown error occurred, please try logging in again.</p>
    @ReLoginButtons()
    @ContactLinks()
}

@code {
    private string? errorCode;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("error", out var value))
        {
            errorCode = value.ToString();
            errorMessage = MapErrorMessage(errorCode);
        }
    }

    private string MapErrorMessage(string code) => code switch
    {
        "discord-auth-failed" => "",
        "reddit-auth-failed" => "",
        "missingid" => "",
        "invalid-discord-id" => "",
        "not-registered" => "",
        _ => "An unknown authentication error occurred."
    };

    private void ReauthenticateWithReddit() => NavigationManager.NavigateTo("/auth-reddit", forceLoad: true);
    private void ReauthenticateWithDiscord() => NavigationManager.NavigateTo("/auth-discord", forceLoad: true);

    private RenderFragment ReLoginButtons() => __builder =>
    {
        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="ReauthenticateWithReddit">
                Login with Reddit
            </button>
            <button class="btn btn-primary" @onclick="ReauthenticateWithDiscord">
                Login with Discord
            </button>
        </div>
    };

    private RenderFragment ContactLinks() => __builder =>
    {
        <p>
            If you are still having issues, please
            <a class="btn btn-secondary" href="https://discord.com/users/683329382952992791" target="_blank">
                DM shen3340 on Discord
            </a>
            or
            <a class="btn btn-secondary" href="https://www.reddit.com/message/compose/?to=Disastrous_Rush4196"
               target="_blank" rel="noopener noreferrer">
                DM Disastrous_Rush4196 on Reddit
            </a>
        </p>
    };
}